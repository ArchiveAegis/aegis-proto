syntax = "proto3";

package datasource.v1;

option go_package = "gen/go/datasource/v1;datasourcev1";

import "google/protobuf/any.proto";
import "google/protobuf/struct.proto";

service DataSource {
  rpc GetPluginInfo(GetPluginInfoRequest) returns (GetPluginInfoResponse);
  rpc Execute(RequestEnvelope) returns (ResponseEnvelope);
  rpc HealthCheck(HealthCheckRequest) returns (HealthCheckResponse);
}

message RequestEnvelope {
  string request_id = 1;
  string biz_name = 2;
  map<string, string> metadata = 3;
  google.protobuf.Any payload = 4;
}

message ResponseEnvelope {
  string request_id = 1;
  Status status = 2;
  google.protobuf.Any payload = 3;
  string action = 4;
}

message Status {
  int32 code = 1;
  string message = 2;
  google.protobuf.Struct details = 3;
}

message GetPluginInfoRequest {}

message GetPluginInfoResponse {
  string name = 1;
  string version = 2;
  string type = 3;
  string description_markdown = 4;
  ApiVersion contract_version = 5;
  repeated string supported_payloads = 6;
  repeated string supported_capabilities = 7;
}

message ApiVersion {
  int32 major = 1;
  int32 minor = 2;
  int32 patch = 3;
}

message DataQueryRequest {
  google.protobuf.Struct query = 1;
}

message DataQueryResult {
  google.protobuf.Struct data = 1;
}

message DataMutateRequest {
  string operation = 1;
  google.protobuf.Struct payload = 2;
}

message DataMutateResult {
  google.protobuf.Struct data = 1;
}

message GetSchemaRequest {
  string table_name = 1;
}

message SchemaResult {
  map<string, TableSchema> tables = 1;
}

message TableSchema {
  repeated FieldDescription fields = 1;
}

message FieldDescription {
  string name = 1;
  string data_type = 2;
  bool is_searchable = 3;
  bool is_returnable = 4;
  bool is_primary = 5;
  string description = 6;
}

message UpdateConfigurationRequest {
  google.protobuf.Struct new_config = 1;
}

message UpdateConfigurationResult {
  string message = 1;
}

message HealthCheckRequest {}

message HealthCheckResponse {
  enum ServingStatus {
    UNKNOWN = 0;
    SERVING = 1;
    NOT_SERVING = 2;
  }
  ServingStatus status = 1;
}

message TriggerBackupRequest {
  string backup_destination_dir = 1;
}

message TriggerBackupResult {
  string final_backup_path = 1;
  int64 file_size = 2;
  int32 db_files_count = 3;
}

message SharedMemoryHandle {
  string file_path = 1;
  int64 offset = 2;
  int64 length = 3;
  string format = 4;
  int64 rows = 5;
  map<string, string> metadata = 6;
}
