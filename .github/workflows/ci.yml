name: Proto CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  generate-and-check:
    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, macos-latest, windows-latest ]
    runs-on: ${{ matrix.os }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: false

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install -q --upgrade pip
          python -m pip install -q -r requirements.txt
        shell: bash

      - name: Install Task
        uses: arduino/setup-task@v2
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cache Protobuf compiler
        id: cache-protoc
        uses: actions/cache@v4
        with:
          path: ~/protoc
          key: protoc-25.3-${{ matrix.os }}

      - name: Install Protobuf compiler (if not cached)
        if: steps.cache-protoc.outputs.cache-hit != 'true'
        uses: arduino/setup-protoc@v2
        with:
          version: '25.3'
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Go protobuf plugins
        run: |
          go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
          go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest
          echo "${HOME}/go/bin" >> $GITHUB_PATH
        shell: bash

      - name: Generate Protobuf code
        run: task gen

      - name: Check generated files are committed
        run: |
          if [[ "${{ runner.os }}" == "Windows" ]]; then
            git config core.autocrlf false
          fi
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "::error::Generated files are not committed. Run 'task gen' and commit the changes."
            git --no-pager diff
            exit 1
          fi
        shell: bash
